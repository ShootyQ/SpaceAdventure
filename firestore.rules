rules_version = "2";
service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
       return request.auth != null && (
         request.auth.token.email == "andrewpcarlson85@gmail.com" || 
         request.auth.token.email == "mr@shootyq.com"
       );
    }
    
    function isCoTeacher(teacherId) {
        let teacherDoc = get(/databases/$(database)/documents/users/$(teacherId));
        return request.auth.token.email in teacherDoc.data.coTeacherEmails;
    }

    function isTeacher() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "teacher";
    }

    // Public, non-sensitive aggregated stats for the marketing homepage.
    match /public-stats/{docId} {
      allow read: if docId == "landing";
      allow write: if docId == "landing" && request.auth != null;
    }

    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        resource.data.teacherId == request.auth.uid || 
        (resource.data.teacherId != null && isCoTeacher(resource.data.teacherId)) ||
        isCoTeacher(userId) ||
        isAdmin()
      );
      
      allow create: if request.auth != null;
      
      allow update, delete: if request.auth != null && (
        request.auth.uid == userId || 
        resource.data.teacherId == request.auth.uid || 
        (resource.data.teacherId != null && isCoTeacher(resource.data.teacherId)) || 
        isCoTeacher(userId) ||
        isAdmin()
      );
      
      // Subcollections used by Teachers
      match /behaviors/{docId} {
        allow read: if request.auth != null; // Students need to read protocols
        allow write: if request.auth != null && (request.auth.uid == userId || isCoTeacher(userId));
      }
      match /missions/{docId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (request.auth.uid == userId || isCoTeacher(userId));
      }
      match /planets/{docId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (request.auth.uid == userId || isCoTeacher(userId));
      }
      match /settings/{docId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (request.auth.uid == userId || isCoTeacher(userId));
      }
    }

    match /missions/{missionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.teacherId == request.auth.uid;
    }
    
    match /behaviors/{behaviorId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.teacherId == request.auth.uid;
    }
    
    match /planets/{planetId} {
      // Planet IDs are often composite "teacherId_planetId" or just "planetId" (legacy)
      // Allow read for everyone (students need to see planets)
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // Only allow updates if:
      // 1. You are the teacher owner (teacherId field matches)
      // 2. OR you are adding XP via transaction (complicated to check rules for incremental updates without cloud functions, but basic write check works)
      allow update, delete: if request.auth != null && (
          resource.data.teacherId == request.auth.uid || 
          // Allow students to "touch" planets? No, students update their own user record, and transactions might update planets?
          // Actually, handleAward (Teacher side) updates planet.
          // Students don"t update planets directly usually.
          false
      ) || isAdmin();
    }
    
    match /game-config/{configId} {
      allow read: if request.auth != null;
      // Allow write if you are a teacher (to manage asteroid events) or if it"s the global config
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "teacher" ||
        configId == "asteroidEvent" // Keep global open for now if migration needed, but preferably restrict
      ); 
    }
    match /ships/{shipId} {
      allow read, write: if request.auth != null;
    }
  }
}
